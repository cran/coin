<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>coin: CIstuff.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.4 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a></div>
<h1>CIstuff.c</h1><a href="CIstuff_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00009"></a>00009 <span class="preprocessor">#include "<a class="code" href="CI__common_8h.html">CI_common.h</a>"</span>
<a name="l00010"></a>00010 
<a name="l00011"></a><a class="code" href="CIstuff_8h.html#a0">00011</a> <span class="keywordtype">int</span> <a class="code" href="CIstuff_8c.html#a0">nrow</a>(SEXP x) {
<a name="l00012"></a>00012     SEXP a;
<a name="l00013"></a>00013 
<a name="l00014"></a>00014     a = getAttrib(x, R_DimSymbol);
<a name="l00015"></a>00015     <span class="keywordflow">if</span> (a == R_NilValue) {
<a name="l00016"></a>00016         <span class="keywordflow">return</span>(LENGTH(x));
<a name="l00017"></a>00017     } <span class="keywordflow">else</span> {
<a name="l00018"></a>00018         <span class="keywordflow">return</span>(INTEGER(getAttrib(x, R_DimSymbol))[0]);
<a name="l00019"></a>00019     }
<a name="l00020"></a>00020 }
<a name="l00021"></a>00021     
<a name="l00022"></a><a class="code" href="CIstuff_8h.html#a1">00022</a> <span class="keywordtype">int</span> <a class="code" href="CIstuff_8c.html#a1">ncol</a>(SEXP x) {
<a name="l00023"></a>00023     SEXP a;
<a name="l00024"></a>00024     
<a name="l00025"></a>00025     a = getAttrib(x, R_DimSymbol);
<a name="l00026"></a>00026     <span class="keywordflow">if</span> (a == R_NilValue) {
<a name="l00027"></a>00027         <span class="keywordflow">return</span>(1);
<a name="l00028"></a>00028     } <span class="keywordflow">else</span> {
<a name="l00029"></a>00029         <span class="keywordflow">return</span>(INTEGER(getAttrib(x, R_DimSymbol))[1]);
<a name="l00030"></a>00030     }
<a name="l00031"></a>00031 }
<a name="l00032"></a>00032         
<a name="l00033"></a>00033 
<a name="l00042"></a><a class="code" href="CIstuff_8c.html#a2">00042</a> <span class="keywordtype">void</span> <a class="code" href="CIstuff_8c.html#a2">C_SampleNoReplace</a>(<span class="keywordtype">int</span> *x, <span class="keywordtype">int</span> m, <span class="keywordtype">int</span> k, <span class="keywordtype">int</span> *ans) {
<a name="l00043"></a>00043                          
<a name="l00044"></a>00044     <span class="keywordtype">int</span> i, j, n = m;
<a name="l00045"></a>00045 
<a name="l00046"></a>00046     <span class="keywordflow">for</span> (i = 0; i &lt; m; i++)
<a name="l00047"></a>00047         x[i] = i;
<a name="l00048"></a>00048     <span class="keywordflow">for</span> (i = 0; i &lt; k; i++) {
<a name="l00049"></a>00049         j = n * unif_rand();    
<a name="l00050"></a>00050         ans[i] = x[j];
<a name="l00051"></a>00051         x[j] = x[--n];  
<a name="l00052"></a>00052     }
<a name="l00053"></a>00053 }
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 
<a name="l00056"></a><a class="code" href="CIstuff_8c.html#a3">00056</a> SEXP <a class="code" href="CIstuff_8c.html#a3">R_blocksetup</a> (SEXP block) {
<a name="l00057"></a>00057 
<a name="l00058"></a>00058     <span class="keywordtype">int</span> n, nlev, nlevels, i, j, *iblock, l;
<a name="l00059"></a>00059     SEXP ans, dims, indices, dummies, pindices, lindex;
<a name="l00060"></a>00060     
<a name="l00061"></a>00061     n = LENGTH(block);
<a name="l00062"></a>00062     iblock = INTEGER(block);
<a name="l00063"></a>00063     nlevels = 1;
<a name="l00064"></a>00064     <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {
<a name="l00065"></a>00065         <span class="keywordflow">if</span> (iblock[i] &gt; nlevels) nlevels++;
<a name="l00066"></a>00066     }
<a name="l00067"></a>00067     
<a name="l00068"></a>00068     PROTECT(ans = allocVector(VECSXP, 4));
<a name="l00069"></a>00069     SET_VECTOR_ELT(ans, 0, dims = allocVector(INTSXP, 2));
<a name="l00070"></a>00070     SET_VECTOR_ELT(ans, 1, indices = allocVector(VECSXP, nlevels));
<a name="l00071"></a>00071     SET_VECTOR_ELT(ans, 2, dummies = allocVector(VECSXP, nlevels));
<a name="l00072"></a>00072     SET_VECTOR_ELT(ans, 3, pindices = allocVector(VECSXP, nlevels));
<a name="l00073"></a>00073     
<a name="l00074"></a>00074     INTEGER(dims)[0] = n;
<a name="l00075"></a>00075     INTEGER(dims)[1] = nlevels;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     <span class="keywordflow">for</span> (l = 1; l &lt;= nlevels; l++) {
<a name="l00078"></a>00078     
<a name="l00079"></a>00079         <span class="comment">/* number of elements in block `l' */</span>
<a name="l00080"></a>00080         nlev = 0;   
<a name="l00081"></a>00081         <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {
<a name="l00082"></a>00082             <span class="keywordflow">if</span> (iblock[i] == l) nlev++;
<a name="l00083"></a>00083         }
<a name="l00084"></a>00084                                                 
<a name="l00085"></a>00085         <span class="comment">/* which(block == l) and memory setup */</span>
<a name="l00086"></a>00086         SET_VECTOR_ELT(indices, l - 1, lindex = allocVector(INTSXP, nlev));
<a name="l00087"></a>00087         SET_VECTOR_ELT(dummies, l - 1, allocVector(INTSXP, nlev));
<a name="l00088"></a>00088         SET_VECTOR_ELT(pindices, l - 1, allocVector(INTSXP, nlev));
<a name="l00089"></a>00089 
<a name="l00090"></a>00090         j = 0;
<a name="l00091"></a>00091         <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {   
<a name="l00092"></a>00092             <span class="keywordflow">if</span> (iblock[i] == l) {
<a name="l00093"></a>00093                 INTEGER(lindex)[j] = i;
<a name="l00094"></a>00094                 j++; 
<a name="l00095"></a>00095             }
<a name="l00096"></a>00096         }
<a name="l00097"></a>00097     }
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     UNPROTECT(1);
<a name="l00100"></a>00100     <span class="keywordflow">return</span>(ans);
<a name="l00101"></a>00101 }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 
<a name="l00110"></a><a class="code" href="CIstuff_8c.html#a4">00110</a> <span class="keywordtype">void</span> <a class="code" href="CIstuff_8c.html#a4">C_blockperm</a> (SEXP blocksetup, <span class="keywordtype">int</span> *ans) {
<a name="l00111"></a>00111                   
<a name="l00112"></a>00112     <span class="keywordtype">int</span> n, nlevels, l, nlev, j, *iindex, *ipindex;
<a name="l00113"></a>00113     SEXP indices, dummies, pindices, index, dummy, pindex;
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     n = INTEGER(VECTOR_ELT(blocksetup, 0))[0];
<a name="l00116"></a>00116     nlevels = INTEGER(VECTOR_ELT(blocksetup, 0))[1];
<a name="l00117"></a>00117     indices = VECTOR_ELT(blocksetup, 1);
<a name="l00118"></a>00118     dummies = VECTOR_ELT(blocksetup, 2);
<a name="l00119"></a>00119     pindices = VECTOR_ELT(blocksetup, 3);
<a name="l00120"></a>00120     
<a name="l00121"></a>00121     <span class="keywordflow">for</span> (l = 1; l &lt;= nlevels; l++) {
<a name="l00122"></a>00122     
<a name="l00123"></a>00123         <span class="comment">/* number of elements in block `l' */</span>
<a name="l00124"></a>00124         index = VECTOR_ELT(indices, l - 1);
<a name="l00125"></a>00125         dummy = VECTOR_ELT(dummies, l - 1);
<a name="l00126"></a>00126         pindex = VECTOR_ELT(pindices, l - 1);
<a name="l00127"></a>00127         nlev = LENGTH(index);
<a name="l00128"></a>00128         iindex = INTEGER(index);
<a name="l00129"></a>00129         ipindex = INTEGER(pindex);
<a name="l00130"></a>00130 
<a name="l00131"></a>00131         <a class="code" href="CIstuff_8c.html#a2">C_SampleNoReplace</a>(INTEGER(dummy), nlev, nlev, ipindex);
<a name="l00132"></a>00132 
<a name="l00133"></a>00133         <span class="keywordflow">for</span> (j = 0; j &lt; nlev; j++) {
<a name="l00134"></a>00134             ans[iindex[j]] = iindex[ipindex[j]];
<a name="l00135"></a>00135         }
<a name="l00136"></a>00136     }
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a><a class="code" href="CIstuff_8c.html#a5">00139</a> SEXP <a class="code" href="CIstuff_8c.html#a5">R_blockperm</a> (SEXP block) {
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     SEXP blocksetup, ans;
<a name="l00142"></a>00142     
<a name="l00143"></a>00143     blocksetup = <a class="code" href="CIstuff_8c.html#a3">R_blocksetup</a>(block);
<a name="l00144"></a>00144     PROTECT(ans = allocVector(INTSXP, LENGTH(block)));
<a name="l00145"></a>00145     GetRNGstate();
<a name="l00146"></a>00146     <a class="code" href="CIstuff_8c.html#a4">C_blockperm</a>(blocksetup, INTEGER(ans));
<a name="l00147"></a>00147     PutRNGstate();
<a name="l00148"></a>00148     UNPROTECT(1);
<a name="l00149"></a>00149     <span class="keywordflow">return</span>(ans);
<a name="l00150"></a>00150 }
<a name="l00151"></a>00151 
<a name="l00152"></a><a class="code" href="CIstuff_8c.html#a6">00152</a> SEXP <a class="code" href="CIstuff_8c.html#a6">R_MonteCarloIndependenceTest</a> (SEXP x, SEXP y, SEXP block, SEXP B) {
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <span class="keywordtype">int</span> n, p, q, pq, i, *index, *permindex, b, Bsim;
<a name="l00155"></a>00155     SEXP ans, blocksetup, linstat;
<a name="l00156"></a>00156     <span class="keywordtype">double</span> *dans, *dlinstat, *dx, *dy, f = 0.1;
<a name="l00157"></a>00157     
<a name="l00158"></a>00158     n = <a class="code" href="CIstuff_8c.html#a0">nrow</a>(x);
<a name="l00159"></a>00159     p = <a class="code" href="CIstuff_8c.html#a1">ncol</a>(x);
<a name="l00160"></a>00160     q = <a class="code" href="CIstuff_8c.html#a1">ncol</a>(y);
<a name="l00161"></a>00161     pq = p*q;
<a name="l00162"></a>00162     Bsim = INTEGER(B)[0];
<a name="l00163"></a>00163     dx = REAL(x);
<a name="l00164"></a>00164     dy = REAL(y);
<a name="l00165"></a>00165     
<a name="l00166"></a>00166     index = Calloc(n, <span class="keywordtype">int</span>);
<a name="l00167"></a>00167     permindex = Calloc(n, <span class="keywordtype">int</span>);
<a name="l00168"></a>00168 
<a name="l00169"></a>00169     PROTECT(blocksetup = <a class="code" href="CIstuff_8c.html#a3">R_blocksetup</a>(block));
<a name="l00170"></a>00170 
<a name="l00171"></a>00171     PROTECT(ans = allocMatrix(REALSXP, pq, Bsim));
<a name="l00172"></a>00172     dans = REAL(ans);
<a name="l00173"></a>00173     PROTECT(linstat = allocVector(REALSXP, pq));
<a name="l00174"></a>00174     dlinstat = REAL(linstat);
<a name="l00175"></a>00175     
<a name="l00176"></a>00176     <span class="keywordflow">for</span> (i = 0; i &lt; n; i++)
<a name="l00177"></a>00177         index[i] = i;
<a name="l00178"></a>00178         
<a name="l00179"></a>00179     GetRNGstate();
<a name="l00180"></a>00180         
<a name="l00181"></a>00181     <span class="keywordflow">for</span> (b = 0; b &lt; Bsim; b++) {
<a name="l00182"></a>00182 
<a name="l00183"></a>00183         <a class="code" href="CIstuff_8c.html#a4">C_blockperm</a>(blocksetup, permindex);
<a name="l00184"></a>00184         <a class="code" href="LinearStatistic_8c.html#a8">C_PermutedLinearStatistic</a>(dx, p, dy, q, n, n, index, permindex, dlinstat);
<a name="l00185"></a>00185         
<a name="l00186"></a>00186         <span class="keywordflow">for</span> (i = 0; i &lt; pq; i++) dans[b*pq + i] = dlinstat[i];
<a name="l00187"></a>00187         
<a name="l00188"></a>00188         <span class="comment">/* check user interrupts */</span>
<a name="l00189"></a>00189         <span class="keywordflow">if</span> (b &gt; Bsim * f) {
<a name="l00190"></a>00190             R_CheckUserInterrupt();
<a name="l00191"></a>00191             f += 0.1;
<a name="l00192"></a>00192         }
<a name="l00193"></a>00193     }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     PutRNGstate();
<a name="l00196"></a>00196 
<a name="l00197"></a>00197     UNPROTECT(3);
<a name="l00198"></a>00198     <span class="keywordflow">return</span>(ans);
<a name="l00199"></a>00199 }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 
<a name="l00202"></a><a class="code" href="CIstuff_8c.html#a7">00202</a> SEXP <a class="code" href="CIstuff_8c.html#a7">R_maxstattrafo</a>(SEXP x, SEXP cutpoints) {
<a name="l00203"></a>00203 
<a name="l00204"></a>00204     <span class="keywordtype">int</span> i, j, n, nc, jn;
<a name="l00205"></a>00205     SEXP ans;
<a name="l00206"></a>00206     <span class="keywordtype">double</span> *dans, *dx, *dcutpoints, cj;
<a name="l00207"></a>00207     
<a name="l00208"></a>00208     <span class="keywordflow">if</span> (!isReal(x) || !isReal(cutpoints))
<a name="l00209"></a>00209         error(<span class="stringliteral">"x or cutpoints are not of type REALSXP"</span>);
<a name="l00210"></a>00210         
<a name="l00211"></a>00211     n = LENGTH(x);
<a name="l00212"></a>00212     nc = LENGTH(cutpoints);
<a name="l00213"></a>00213     PROTECT(ans = allocMatrix(REALSXP, n, nc));
<a name="l00214"></a>00214     dans = REAL(ans);
<a name="l00215"></a>00215     dx = REAL(x);
<a name="l00216"></a>00216     dcutpoints = REAL(cutpoints);
<a name="l00217"></a>00217     
<a name="l00218"></a>00218     <span class="keywordflow">for</span> (j = 0; j &lt; nc; j++) {
<a name="l00219"></a>00219         jn = j * n;
<a name="l00220"></a>00220         cj = dcutpoints[j];
<a name="l00221"></a>00221         <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {
<a name="l00222"></a>00222             <span class="keywordflow">if</span> (dx[i] &gt; cj) {
<a name="l00223"></a>00223                 dans[jn + i] = 0.0;
<a name="l00224"></a>00224             } <span class="keywordflow">else</span> {
<a name="l00225"></a>00225                 dans[jn + i] = 1.0;
<a name="l00226"></a>00226             }
<a name="l00227"></a>00227         }
<a name="l00228"></a>00228     }
<a name="l00229"></a>00229     UNPROTECT(1);
<a name="l00230"></a>00230     <span class="keywordflow">return</span>(ans);
<a name="l00231"></a>00231 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Aug 24 16:12:56 2006 for coin by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.4 </small></address>
</body>
</html>
